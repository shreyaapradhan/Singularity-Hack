<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raahi ‚Äì Safety Setup</title>

  <style>
    /* üîí SAME CSS ‚Äì UNCHANGED */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#0f172a;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
    .container{background:#020617;border-radius:12px;max-width:480px;width:100%;overflow:hidden;}
    .header{text-align:center;color:white;padding:30px;border-bottom:2px solid #1e293b;}
    .shield-icon{font-size:50px;}
    .form-container{padding:30px;}
    .form-group{margin-bottom:18px;}
    label{color:#e2e8f0;font-size:13px;font-weight:600;}
    input,select{width:100%;padding:12px;border-radius:8px;background:#0f172a;color:white;border:2px solid #1e293b;}
    .submit-btn{width:100%;padding:14px;background:#2563eb;color:white;border:none;border-radius:8px;font-weight:700;margin-top:20px;}
    .submit-btn:hover{background:#1d4ed8;}
    .hidden{display:none;}
  </style>
</head>

<body>

<div class="container">
  <div class="header">
    <div class="shield-icon">üõ°Ô∏è</div>
    <h1>Raahi</h1>
    <p>Your personal safety companion</p>
  </div>

  <form class="form-container" onsubmit="handleSubmit(event)">
    <div class="form-group">
      <label>Full Name *</label>
      <input id="fullname" required>
    </div>

    <div class="form-group">
      <label>Mobile *</label>
      <input id="mobile" pattern="[0-9]{10}" required>
    </div>

    <div class="form-group">
      <label>State *</label>
      <input id="state" required>
    </div>

    <div class="form-group">
      <label>City *</label>
      <input id="city" required>
    </div>

    <div class="form-group">
      <label>Trusted Contact 1</label>
      <input id="contact1">
    </div>

    <button class="submit-btn">Complete Setup</button>
  </form>
</div>

<script>
  let sosId = null;
  let locationInterval = null;

  /* üß† STEP 1: REGISTER USER */
  async function handleSubmit(event) {
    event.preventDefault();

    const user = {
      name: fullname.value,
      phone: mobile.value,
      state: state.value,
      city: city.value,
      trustedContacts: [contact1.value]
    };

    try {
      const res = await fetch("http://localhost:8080/api/users/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(user)
      });

      const savedUser = await res.json();
      localStorage.setItem("userId", savedUser.id);

      await startSOS(savedUser.id);
    } catch (err) {
      alert("Backend not running");
    }
  }

  /* üö® STEP 2: START SOS */
  async function startSOS(userId) {
    const res = await fetch(`http://localhost:8080/api/sos/start/${userId}`, {
      method: "POST"
    });

    const sos = await res.json();
    sosId = sos.id;

    localStorage.setItem("sosId", sosId);
    startTracking();
  }

  /* üìç STEP 3: REAL GPS TRACKING */
  function startTracking() {
    if (!navigator.geolocation) {
      alert("GPS not supported");
      return;
    }

    locationInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(sendLocation, geoError, {
        enableHighAccuracy: true
      });
    }, 10000);

    alert("üü¢ Live tracking activated");
    window.location.href = "calc.html";
  }

  /* üì° STEP 4: SEND LOCATION */
  async function sendLocation(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    console.log("üìç Sending:", lat, lng);

    await fetch(`http://localhost:8080/api/location/${sosId}?latitude=${lat}&longitude=${lng}`, {
      method: "POST"
    });
  }

  function geoError() {
    alert("Location permission denied");
  }
</script>

</body>
</html>
